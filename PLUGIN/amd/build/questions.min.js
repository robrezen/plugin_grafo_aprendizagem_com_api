define(["jquery","core/log","mod_learninggraph/getGraph"],function(e,t,n){return{init(s,i){function a(n){t.debug("Send questions to api."),e.ajax({url:M.cfg.wwwroot+"/mod/learninggraph/send_data_to_api.php",type:"GET",data:{questionids:n,instance:i},success(s){t.debug(s),o(),function n(s){let i=0,a=()=>{e.ajax({url:M.cfg.wwwroot+"/mod/learninggraph/check_data_returned.php",type:"GET",data:{questionids:s},success(e){t.debug(e);let n=JSON.parse(e),s=!0;n.status.forEach(e=>{"processed"!==e&&(s=!1)}),s||i>=12?o():(i++,setTimeout(a,5e3))},error(e){t.error("Failed to check question status",e)}})};a()}(n)},error(){alert("Failed to send questions to API."),o()}})}function o(){t.debug("Fetch questions for course module."),e.ajax({url:M.cfg.wwwroot+"/mod/learninggraph/fetch_questions.php",type:"GET",data:{courseid:s},success(o){let d=document.getElementById("questionsTable");e("#questionsTable tr:not(:first)").remove(),Object.values(o).forEach(e=>{let t=d.insertRow(),n="processing"===e.graphstatus?"disabled":"";t.innerHTML=`
    <td><input type="checkbox" name="selected_questions[]" value="${e.id}"></td>
    <td>${e.id}</td>
    <td>${e.graphstatus}</td>
    <td>${e.questiontext.substring(0,50)}</td>
    <td>
        <button class="btn btn-primary view-graph-btn" data-id="${e.id}" data-text="${e.questiontext}" ${n}>
            <span class="material-symbols-outlined">linked_services</span>
        </button>
    </td>
    <td>
        <button class="btn btn-primary send-question-btn" data-id="${e.id}" data-text="${e.questiontext}" ${n}>Send to API</button>
    </td>
`}),document.getElementById("send-selected-btn").addEventListener("click",()=>{!function e(){let t=document.querySelectorAll('input[name="selected_questions[]"]:checked'),n=Array.from(t).map(e=>e.value);if(0===n.length){alert("Please select at least one question.");return}let s=n.join(",");a(s)}()}),document.getElementById("send-all-btn").addEventListener("click",()=>{!function e(){let t=Array.from(document.querySelectorAll('input[name="selected_questions[]"]')).map(e=>e.value);if(0===t.length){alert("Nothing to send. Insert questions first.");return}let n=t.join(",");a(n)}()}),document.querySelectorAll(".send-question-btn:not([disabled])").forEach(e=>{e.addEventListener("click",function(){let e=this.getAttribute("data-id");a(e)})}),document.querySelectorAll(".view-graph-btn:not([disabled])").forEach(e=>{e.addEventListener("click",function(){var e,a;let o=this.getAttribute("data-id");e=o,t.debug("View graph for question "+e),a=document.createElement("div"),a.setAttribute("id","graphModal"),a.setAttribute("class","modal"),a.innerHTML=`
<div class="modal-content">
<button class="close-modal">&times;</button>
<div id="question-graph-container" style="width: 100%; height: 90%;"></div>
</div>
`,document.body.appendChild(a),a.getElementsByClassName("close-modal")[0].onclick=()=>{a.style.display="none",a.remove()},window.onclick=e=>{e.target==a&&(a.style.display="none",a.remove())},a.style.display="block",n.getQuestionGraph(s,i,e)})})},error(e){t.debug(e),alert("Failed to fetch questions.")}})}o()}}});